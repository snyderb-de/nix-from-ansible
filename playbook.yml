# playbook.yml
- name: 🚀 Bootstrap Nix with Ansible (modular)
  hosts: localhost
  gather_facts: true
  gather_subset:
    - min
  become: true

  vars:
    log_dir: "{{ '~' | expanduser }}/nix-bootstrap-logs"
    log_file: "{{ log_dir }}/nix-bootstrap-{{ ansible_date_time.iso8601_basic_short }}.log"
    error_log_file: "{{ log_dir }}/nix-bootstrap-errors-{{ ansible_date_time.iso8601_basic_short }}.log"

  pre_tasks:
    - name: 📁 Create logging directory
      file:
        path: "{{ log_dir }}"
        state: directory
        mode: '0755'
      become: true
      tags: [logging]

  roles:
    - role: common
      tags: [common, nix, flake, logging]
    - role: mac_shell
      tags: [mac, shell, apps]
    - role: linux_desktop
      tags: [linux, hyprland]
    - role: languages
      tags: [langs]

  tasks:
    - name: 🧾 Write buffered logs (main)
      when: log_buffer is defined and not ansible_check_mode
      copy:
        dest: "{{ log_file }}"
        content: "{{ log_buffer }}\n"
        mode: '0644'
      become: true
      tags: [logging]

    - name: 🧾 Write buffered error logs
      when: error_log_buffer is defined and not ansible_check_mode
      copy:
        dest: "{{ error_log_file }}"
        content: "{{ error_log_buffer }}\n"
        mode: '0644'
      become: true
      tags: [logging]

    - name: 📋 Display log file locations
      debug:
        msg: |
          🎯 Bootstrap completed (roles). Check logs for details:
          📝 Main log: {{ log_file }}
          ❌ Error log: {{ error_log_file }}
      tags: [summary]